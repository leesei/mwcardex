(function(e){"use strict";function n(){var e,n,t=function(){},o=0;if(window.console?window.console.debug||void 0===window.console.log||(window.console.debug=window.console.log):window.console={},n=["verbose","log","debug","info","warn","error","assert","dir","dirxml","group","groupEnd","time","timeEnd","count","trace","profile","profileEnd"],o){for(e=0;n.length>e;++e)window.console[n[e]]||(window.console[n[e]]=t);d||(console.debug=t,console.dir=t),console.verbose=a?console.log:t}else for(e=0;n.length>e;++e)window.console[n[e]]=t}function t(){console.group("monitorAppCacheUpdate()"),console.debug("monitorAppCacheUpdate()");var e,n,t=[];t[0]="uncached",t[1]="idle",t[2]="checking",t[3]="downloading",t[4]="updateready",t[5]="obsolete",e=function(e){var o,i,l,s;o=navigator.onLine?"yes":"no",i=t[n.status],l=e.type,s="online: "+o,s+=", event: "+l,s+=", status: "+i,"error"==l&&navigator.onLine&&(s+=" (prolly a syntax error in manifest)"),console.info(s)},n=window.applicationCache,n.addEventListener("cached",e,!1),n.addEventListener("checking",e,!1),n.addEventListener("downloading",e,!1),n.addEventListener("error",e,!1),n.addEventListener("noupdate",e,!1),n.addEventListener("obsolete",e,!1),n.addEventListener("progress",e,!1),n.addEventListener("updateready",e,!1),n.addEventListener("updateready",function(){window.applicationCache.swapCache(),console.log("swap cache has been called"),window.location.reload()},!1),console.groupEnd()}function o(){console.group("mageInfoInit()"),e("#mage-select").on("change",function(){console.debug("render mage[%s] info",this.value),e("#mage-info-holder").html('<img src="mages/'+this.value+'_1.jpg"> '+'<img src="mages/'+this.value+'_2.jpg">')}),console.groupEnd()}function i(){console.group("spellListInit()");var n=[],t=function(n,t){var o,i,l;o=e("<div>").css("float","right");for(l in t.schools)o.append('<img src="images/'+l+'.png">');return-1!=e.inArray("melee.",t.tags)&&o.append('<img src="images/melee.png">'),-1!=e.inArray("range.",t.tags)&&o.append('<img src="images/range.png">'),o.children().addClass("badge-icon"),i=e(sprintf('<li id="%s" class="type-%s">',n,t.type)).append(sprintf('<a href="#">%s</a>',t.name)).append(o).append(e("<div>").addClass("expander"))};e.each(gSpellDB,function(e,o){console.verbose("%s: %O",e,o),n.push(t(e,o)),o.name=o.name.toLowerCase()}),n.sort(function(e,n){var t=e.text(),o=n.text();return t==o?0:t>o?1:o>t?-1:void 0}),g.append(n).on("click","li",function(e){console.verbose("> spell %s clicked",this.id),e.preventDefault(),p.attr("name")!=this.id&&(p.attr("src","spells/"+this.id+".jpg"),p.attr("name",this.id))}),e("#visible-spell-count").text(n.length),console.groupEnd()}function l(){console.group("init()"),o(),i(),e("#name-filter, #tag-filter").css("width","190px").on("change",function(){s(this)}),e("#name-filter").on("keydown",function(){clearTimeout(c),c=setTimeout(function(){s(this)},r)}).next().on("click",function(){e(this).prev().val("").change()}),e("#tag-filter").select2({multiple:!0,containerCss:{"font-size":"0.9em"},dropdownCss:{width:"250px","font-size":"0.9em"},query:function(n){var t={more:!1,results:[]},o=[],i=[];e.each(gSpellSubtypes,function(){(0===n.term.length||-1!==this.indexOf(n.term))&&o.push({id:this,text:this})}),console.verbose("subtypes: %O",o),o.length&&t.results.push({text:"Subtypes",children:o}),e.each(gSpellTags,function(){(0===n.term.length||-1!==this.indexOf(n.term))&&i.push({id:this,text:this})}),console.verbose("tags: %O",i),i.length&&t.results.push({text:"Tags",children:i}),console.log('tag-filter: "%s"; subtypes[%d] tags[%d]',n.term,o.length,i.length),n.callback(t)}}).next().on("click",function(){e("#tag-filter").select2("val",""),s(this)}),e("#school-filter-all").on("click",function(){u.prop("checked",!0),s(this)}),e("#school-filter-none").on("click",function(){u.prop("checked",!1),s(this)}),u.prop("checked",!0).on("change",function(){s(this)}),e("#type-filter-all").on("click",function(){m.prop("checked",!0),s(this)}),e("#type-filter-none").on("click",function(){m.prop("checked",!1),s(this)}),m.prop("checked",!0).on("change",function(){s(this)}),p.on("load",function(){h.empty()}).on("click",function(){h.empty(),this.name&&h.append(e("<div>").html("Subtypes: "+gSpellDB[this.name].subtypes)).append(e("<div>").html("Tags: "+gSpellDB[this.name].tags))}),console.groupEnd()}function s(n){console.group("filterSpells (triggerer: %O)",n),console.time("> [total]");var t,o,i=!1,l=g.children(),s=u.filter(":checked"),c={},r=m.filter(":checked"),d="",a=e.trim(e("#name-filter").val()).toLowerCase(),h=e.trim(e("#tag-filter").val()).toLowerCase(),v=h.length?h.split(","):[];g.after(f).detach(),""!==p.attr("name")&&(p.attr("src","spells/mwspell.png"),p.attr("name","")),l.removeClass("hidden"),console.time("school-filter"),i||(o=s.length,0===o?(console.info("> [school] none selected, quit"),l.addClass("hidden"),i=!0):o==u.length?console.info("> [school] all, skip filtering"):(s.each(function(){c[this.value]=!0}),t=l.filter(':not(".hidden")'),console.log("> [school] filter[%O] on %d checked, %d visible",c,s.length,t.length),t.filter(function(){console.verbose(">> [school] #%s %O",this.id,gSpellDB[this.id].schools);for(var e in gSpellDB[this.id].schools)if(e in c)return!1;return!0}).addClass("hidden"))),console.timeEnd("school-filter"),console.time("type-filter"),i||(o=r.length,0===o?(console.info("> [type] none selected, quit"),l.addClass("hidden"),i=!0):o==m.length?console.info("> [type] all, skip filtering"):(r.each(function(){d+=this.value}),t=l.filter(':not(".hidden")'),console.log("> [type] filter[%s] on %d checked, %d visible",d,r.length,t.length),t.filter(function(){return-1===e.inArray(gSpellDB[this.id].type,d)}).addClass("hidden"))),console.timeEnd("type-filter"),console.time("name-filter"),i||(a.length?(t=l.filter(':not(".hidden")'),console.log("> [name] filter[%s], %d visible",a,t.length),t.filter(function(){return console.verbose('>> [name] "%s" in "%s" = %d',a,gSpellDB[this.id].name,gSpellDB[this.id].name.indexOf(a)),-1===gSpellDB[this.id].name.indexOf(a)}).addClass("hidden")):console.info("> [name] skipped")),console.timeEnd("name-filter"),console.time("tag-filter"),i||(v.length?(t=l.filter(':not(".hidden")'),console.log("> [tag] '%O', %d visible",v,t.length),t.filter(function(){var n;for(n=0;v.length>n;n++)if(-1!==e.inArray(v[n],gSpellDB[this.id].tags))return!1;return!0}).addClass("hidden")):console.info("> [tag] skipped")),console.timeEnd("tag-filter"),f.after(g).detach(),console.timeEnd("> [total]"),t=l.filter(':not(".hidden")'),console.info("filter done, %d visible",t.length),e("#visible-spell-count").text(t.length),console.groupEnd()}var c,r=200,d=1,a=0,h=e("#spell-desc-holder"),p=e("#spell-img-holder"),g=e("#spell-list-holder"),f=e("<div/>",{id:"slholder-stub"}),u=e("#school-filters").find("input:checkbox"),m=e("#type-filters").find("input:checkbox");e(document).ready(function(){n(),t(),l()})})(jQuery);